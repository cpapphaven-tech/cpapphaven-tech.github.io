<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bottle Shoot 3D - PlayMixGames</title>
    <link rel="stylesheet" href="style.css">

    <!-- Three.js + Cannon-ES for physics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>

    <!-- Adsterra Setup -->
    <script type='text/javascript' src='//delicatecatheter.com/f0/67/60/f06760fa6f06fd364ccfb043e0617ad7.js'></script>

    <!-- Tracking -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUrl = new URL(window.location.href);
            const placementId = currentUrl.searchParams.get("placement_id") || "organic";

            const hitData = {
                timestamp: new Date(Date.now() + 19800000).toISOString().replace('Z', '+05:30'),
                url: location.href,
                referrer: document.referrer,
                userAgent: navigator.userAgent,
                screen: { width: screen.width, height: screen.height },
                loadStage: "pre-init",
                placement_id: placementId
            };

            const dataBlob = new Blob([JSON.stringify(hitData)], { type: 'application/json' });
            navigator.sendBeacon("https://zswmqiwrwovndqivndut.supabase.co/functions/v1/track_early_hit", dataBlob);

            let hasPassedOneSec = false;
            let currentConsentObj = null;

            setTimeout(() => { hasPassedOneSec = true; }, 1000);

            let oldPush = __tcfapi;
            __tcfapi = function (command, version, callback) {
                if (command === 'addEventListener') {
                    const originalCallback = callback;
                    callback = function (tcData, success) {
                        try {
                            if (tcData && tcData.eventStatus === 'cmpuishown') {
                                // Ad Modal Visible
                            }
                            if (tcData && tcData.eventStatus === 'useractioncomplete') {
                                // Consent clicked
                            }
                        } catch (e) { }
                        if (originalCallback) originalCallback(tcData, success);
                    }
                }
                return oldPush(command, version, callback);
            };
        });
    </script>
</head>

<body>
    <header>
        <a href="../" class="back-btn">‚Üê PlayMixGames</a>
        <div class="game-title">Bottle Shoot 3D</div>
        <div class="level-display" id="level-ui">Round <span id="round-text">1</span></div>
    </header>

    <div id="game-container">
        <!-- Main Canvas -->
        <canvas id="game-canvas"></canvas>

        <div id="score-display">
            ‚ù§Ô∏è: <span id="lives-display">3</span>
        </div>

        <div id="status-message" class="hidden">Level Clear!</div>

        <!-- Start Screen -->
        <div id="start-screen" class="overlay-screen">
            <div class="screen-content">
                <h1 style="color: #4facfe; margin-bottom: 20px; font-size: 2.5rem; text-shadow: 0 0 10px #4facfe;">
                    BOTTLE SHOOT 3D</h1>
                <p style="margin-bottom: 20px; color: #ccc;">Pull back the sling to shoot.<br>Knock down all bottles
                    before running out of lives!</p>
                <div id="adsterra-banner" style="margin-bottom: 20px; min-height: 50px; background: rgba(0,0,0,0.5);">
                </div>
                <button id="start-btn" class="game-btn"
                    style="background: linear-gradient(45deg, #4facfe, #00f2fe); color: white;">Play</button>
            </div>
        </div>

        <!-- Win/Lose Screen -->
        <div id="win-screen" class="overlay-screen hidden">
            <div class="screen-content">
                <h1 id="winner-text" style="font-size: 3rem; margin-bottom: 10px; text-shadow: 0 0 10px white;">GAME
                    OVER
                </h1>
                <p id="score-text" style="font-size: 1.5rem; margin-bottom: 20px;">Reached Level: 1</p>

                <!-- Watch Ad +1 Life button (only shown on game over, not level clear) -->
                <button id="bonus-btn" class="game-btn"
                    style="background: linear-gradient(45deg, #ff9a00, #f7630c); color: white; display:none;">
                    üéÅ Watch Ad &amp; Get +1 Life
                </button>

                <!-- Main action button (Next Level / Play Again) -->
                <button id="restart-btn" class="game-btn"
                    style="background: linear-gradient(45deg, #4facfe, #00f2fe); color: white;">Play Again</button>

                <!-- Restart from level 1 (only shown on game over) -->
                <button id="restart-level1-btn" class="game-btn"
                    style="background: rgba(255,255,255,0.12); color: #ccc; border: 1px solid rgba(255,255,255,0.2); display:none;">
                    üîÑ Start from Level 1
                </button>
            </div>
        </div>

        <!-- Bottom Ad Banner -->
        <div id="bottom-ad">
            <script type="text/javascript">
                atOptions = {
                    'key': '9afca7470fcf1479ab40cde42718e8f8',
                    'format': 'iframe',
                    'height': 50,
                    'width': 320,
                    'params': {}
                };
            </script>
            <script type="text/javascript"
                src="//delicatecatheter.com/9afca7470fcf1479ab40cde42718e8f8/invoke.js"></script>
        </div>
    </div>

    <!-- Main Game Logic -->
    <script src="game.js"></script>
</body>

</html>