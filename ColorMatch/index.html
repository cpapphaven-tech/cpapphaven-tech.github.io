<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Early Tracking Script -->
    <script>
        (function () {
            const startTime = Date.now();
            const anonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqcGdvdmZ6b25sbWpycnVhc3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjA0MDQsImV4cCI6MjA4NTgzNjQwNH0.fwBaiOgXtnQVgq0IOdPmOskQHDqgOWWqr0mm3PSu57I";
            const endpoint = "https://bjpgovfzonlmjrruaspp.supabase.co/functions/v1/collect";

            const urlParams = new URLSearchParams(window.location.search);
            const placementId = urlParams.get('utm_content') || urlParams.get('placementid');

            const hitData = {
                timestamp: new Date(Date.now() + 19800000).toISOString().replace('Z', '+05:30'),
                url: location.href,
                referrer: document.referrer,
                userAgent: navigator.userAgent,
                screen: { width: screen.width, height: screen.height },
                loadStage: "pre-init",
                placement_id: placementId
            };

            const sendHit = (stage) => {
                hitData.loadStage = stage;
                hitData.timestamp = new Date(Date.now() + 19800000).toISOString().replace('Z', '+05:30');

                if (stage === "early-exit") {
                    hitData.duration_seconds = Math.round((Date.now() - startTime) / 1000);
                }

                fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "apikey": anonKey,
                        "Authorization": "Bearer " + anonKey
                    },
                    body: JSON.stringify(hitData),
                    keepalive: true
                });
            };

            sendHit("pre-init");

            window.addEventListener("pagehide", function () {
                if (!window.FIREBASE_INITIALIZED) {
                    sendHit("early-exit");
                }
            });
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Match 3D - PlayMixGames</title>
    <link rel="stylesheet" href="../portal-style.css">
    <link rel="stylesheet" href="style.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6129521314653726"
        crossorigin="anonymous"></script>
    <script type="module" src="../analytics.js"></script>
    <script type="module" src="../analytics.js"></script>
    <script src="../ads.js"></script>

    <!-- Cookie Consent Script -->
    <script>
        (function () {
            const CONSENT_KEY = 'play-mix-games-cookie-consent';
            function getCookieConsent() {
                const stored = localStorage.getItem(CONSENT_KEY);
                return stored ? JSON.parse(stored) : null;
            }
            function showCookieBanner() {
                const consent = getCookieConsent();
                if (!consent) {
                    const banner = document.getElementById('cookie-consent');
                    if (banner) banner.classList.remove('hidden');
                }
            }
            function acceptCookies() {
                const consent = { accepted: true, timestamp: new Date(Date.now() + 19800000).toISOString().replace('Z', '+05:30') };
                localStorage.setItem(CONSENT_KEY, JSON.stringify(consent));
                document.getElementById('cookie-consent')?.classList.add('hidden');
                window.cookieConsent = true;
                console.log('‚úÖ Cookie consent accepted');
            }
            function declineCookies() {
                const consent = { accepted: false, timestamp: new Date(Date.now() + 19800000).toISOString().replace('Z', '+05:30') };
                localStorage.setItem(CONSENT_KEY, JSON.stringify(consent));
                document.getElementById('cookie-consent')?.classList.add('hidden');
                window.cookieConsent = false;
                console.log('‚ùå Cookie consent declined');
            }
            document.addEventListener('DOMContentLoaded', function () {
                document.getElementById('cookie-accept')?.addEventListener('click', acceptCookies);
                document.getElementById('cookie-decline')?.addEventListener('click', declineCookies);
                setTimeout(showCookieBanner, 500);
            });
            window.cookieConsent = getCookieConsent()?.accepted ?? null;
        })();
    </script>

    <!-- Load Ads Using Professional Control System -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSocialBarAd();
        });
    </script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="../icons/icon-192x192.png">
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>


    <main class="game-container">
        <h1>Color Match 3D</h1>

        <div id="game-ui">
            <div id="top-bar">
                <div id="score-label">Score: <span id="score">0</span></div>
                <div id="timer-label">Time: <span id="timer">30</span>s</div>
            </div>

            <div id="target-container">
                <p>Tap this color:</p>
                <div id="target-color-display"></div>
            </div>

            <div id="main-menu" class="overlay">
                <h2>COLOR MATCH</h2>
                <p>Fast reaction puzzle! Tap the matching cubes.</p>
                <button id="start-btn">Start Game</button>
            </div>

            <div id="game-over" class="overlay hidden">
                <h2>TIME'S UP!</h2>
                <p>Your Score: <span id="final-score">0</span></p>
                <button id="restart-btn">Play Again</button>
            </div>
        </div>

        <canvas id="game-canvas"></canvas>

        <!-- COOKIE CONSENT BANNER -->
        <div id="cookie-consent" class="cookie-banner hidden">
            <div class="cookie-content">
                <div class="cookie-text">
                    <span class="cookie-icon">üç™</span>
                    <span>We use cookies & tracking for ads. <a href="../privacy.html" target="_blank"
                            style="color: #4d79ff; text-decoration: underline;">Learn more</a></span>
                </div>
                <div class="cookie-buttons">
                    <button id="cookie-accept" class="cookie-btn cookie-btn-accept">Accept</button>
                    <button id="cookie-decline" class="cookie-btn cookie-btn-decline">Decline</button>
                </div>
            </div>
        </div>

        <section class="game-description">
            <h2>About Color Match 3D</h2>
            <p>Color Match 3D is a vibrant and addictive reaction game designed to test your visual processing speed and
                accuracy. In this 3D environment, you are presented with a series of colorful cubes and a single "Target
                Color." Your mission is to identify and tap only the cubes that match the target before they disappear
                or the time runs out.</p>

            <p>Perfect for quick gaming sessions, Color Match 3D features procedurally generated levels and a dynamic
                difficulty curve. As you score more points, the colors become more similar and the pace quickens,
                pushing your reflexes to the limit. It's a simple yet incredibly satisfying experience built with
                high-performance WebGL technology for the smootliest possible gameplay.</p>

            <h3>How to Play</h3>
            <ul>
                <li><strong>Identify Target:</strong> Look at the color displayed in the "Tap this color" box at the
                    top.</li>
                <li><strong>Tap Cubes:</strong> Click or tap the 3D cubes in the arena that match that exact color.</li>
            </ul>

            <h3>Scoring Rules</h3>
            <p>Every correct match earns you 1 point. Be careful: tapping a cube of the wrong color will deduct 2
                seconds from your remaining time, ending your run much sooner!</p>

            <h3>Reaction Tips</h3>
            <p>Don't just look at one cube‚Äîtry to scan the entire 3x3 grid as soon as a new color is assigned. Your
                brain can process colors faster than individual shapes, so trust your first instinct and tap quickly to
                maximize your score within the 30-second limit.</p>
        </section>
    </main>

    <footer>
        <div class="footer-links">
            <a href="../index.html">Home</a>
            <a href="../privacy.html">Privacy Policy</a>
            <a href="../terms.html">Terms of Service</a>
            <a href="../contact.html">Contact</a>
        </div>
        <p class="copyright">&copy; 2026 PlayMixGames. <span id="app-version"
                style="opacity: 0.5; font-size: 0.7em;"></span></p>
    </footer>

    <script src="game.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
</body>

</html>